= ec2nodefinder =

This is a rebundling from the Dukes of Erl's ec2nodefinder : http://dukesoferl.blogspot.com/2008/02/automatic-node-discovery.html

= License =
New BSD license (http://www.opensource.org/licenses/bsd-license.php) as the original code is.

= Building =

You need ruby 1.8.6 or 1.8.7, OTP R12B5 and rake on the building machine.

Edit the config.rb file to match your installation.

Edit lib/ec2nodefinder/src/ec2nodefinder.app.src with the appropriate parameters.

Of course you can set them later or pass them on the command line when starting the VM on your EC2 instance.

rake in the main directory will provide you with a tar.gz in the distribs/ folder

And if you provide your S3 credentials and a bucket name in config.rb, `rake upload` will send your release to S3.

= Running on EC2 =

You need a JDK, the EC2 admin tools and, of course, OTP. For each of the nodes :

I recommend Kevin Smith's AMIs : http://weblog.hypotheticalabs.com/?p=383
They have everything bundled in. I expect this code to get into the AMI soon.

On Ubuntu : 
# install erlang

apt-get -y install openjdk-6-jre-headless unzip
wget http://s3.amazonaws.com/ec2-downloads/ec2-api-tools.zip
cd /usr/local/
unzip ~/ec2-api-tools.zip
ln -s ec2-api-tools-1.3-30349/ ec2-api-tools

#Upload your EC2 private key and certificate to your instance.
#Upload your release to your ec2 instance(s) (S3 is a good choice for hosting your release)
sudo erl -boot start_sasl -noshell -eval 'release_handler:unpack_release("<release_name>").' -s init stop

erl -boot start_sasl -name server -kernel inet_dist_listen_min 21000 \
	inet_dist_listen_max 21005 -s inets -setcookie 'XXXXXXXXXXX' -s ec2nodefinder

After a short while (mainly due to JVM startup time) :
(server@domU-12-31-39-02-65-83.compute-1.internal)3> nodes().
['server@domU-12-31-39-02-6A-48.compute-1.internal']

Nodes are discovered !

= Final notes =

- I want to use charpi's Rakefile (http://charpi.net/blog/). It's very good but meant to reorganize the files 
- There's a bug in the 0.0.8 release, which prevented ec2nodefinder from working properly :
in ec2nodefindersrv.erl:143, there's one tl() missing. 
That caused ec2nodefinder to fetch the public DNS name instead of the private one.

- I also added the app.src file for easy configuration.

- You can quite easily reuse the build system. Add your OTP applications in lib/, they'll be built.

- the tar.gz are at least 3Mb, because the base OTP applications are bundled. This insures compatibility. 
  But I could find a way to not bundle them, I'd do that.

= Thanks =
To charpi for the Rakefile
To the dukes of erl for the code !


------
Eric Cestari
http://www.cestari.info